services:
  wef-server:
    build:
      context: ../..
    image: wef-server:e2e
    environment:
      - RUST_LOG=info
      - WEF__TLS__ENABLED=false
      - WEF__SYSLOG__ENABLED=true
      - WEF__SYSLOG__UDP_PORT=5514
      - WEF__SYSLOG__TCP_PORT=5601
      - WEF_ADMIN_USER=e2e
      - WEF_ADMIN_PASS=e2e
    volumes:
      - ./config/wef-server.toml:/etc/wef-server/config.toml:ro
    depends_on:
      - minio
    networks:
      - e2e

  minio:
    image: minio/minio:RELEASE.2024-01-16T16-07-38Z
    environment:
      - MINIO_ROOT_USER=miniouser
      - MINIO_ROOT_PASSWORD=miniopassword
    command: server /data --console-address ':9001'
    expose:
      - "9000"
      - "9001"
    networks:
      - e2e

  minio-setup:
    image: minio/mc:latest
    environment:
      - MINIO_ROOT_USER=miniouser
      - MINIO_ROOT_PASSWORD=miniopassword
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "until mc alias set local http://minio:9000 $$MINIO_ROOT_USER $$MINIO_ROOT_PASSWORD; do sleep 2; done &&
       mc mb --ignore-existing local/wef-events"
    depends_on:
      - minio
    networks:
      - e2e

  wef-generator:
    build:
      context: .
      dockerfile: wef-generator/Dockerfile
    environment:
      - WEF_ENDPOINT=http://wef-server:5985
      - WEF_STATS_ENDPOINT=http://wef-server:5985/stats/throughput
      - PARSER_DIR=/app/parsers
      - EXPECTED_EVENT_IDS=4624,4625,4634,4647,4648,4649,4656,4657,4658,4660,4661,4662,4663,4670,4672,4673,4674,4688,4689,4697,4698,4699,4700,4702,4719,4720,4722,4723,4724,4725,4726,4727,4728,4729,4730,4731,4732,4733,4735,4737,4740,4741,4742,4743,4756,4757,4767,4768,4769,4770
    volumes:
      - ../../config/event_parsers:/app/parsers:ro
    networks:
      - e2e

  syslog-generator:
    build:
      context: .
      dockerfile: syslog-generator/Dockerfile
    environment:
      - SYSLOG_HOST=wef-server
      - SYSLOG_UDP_PORT=5514
      - SYSLOG_TCP_PORT=5601
      - SYSLOG_HTTP_ENDPOINT=http://wef-server:5985/syslog
    depends_on:
      - wef-server
    networks:
      - e2e

  s3-verifier:
    build:
      context: .
      dockerfile: s3-verifier/Dockerfile
    environment:
      - MINIO_ENDPOINT=http://minio:9000
      - MINIO_BUCKET=wef-events
      - AWS_ACCESS_KEY_ID=miniouser
      - AWS_SECRET_ACCESS_KEY=miniopassword
      - WEF_STATS_ENDPOINT=http://wef-server:5985/stats/throughput
      - EXPECTED_EVENT_TOTAL=50
    networks:
      - e2e

networks:
  e2e:
    driver: bridge
