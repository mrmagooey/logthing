services:
  logthing:
    build:
      context: ../../..
    image: logthing:e2e
    environment:
      - RUST_LOG=info
      - WEF__TLS__ENABLED=false
      - WEF__SYSLOG__ENABLED=true
      - WEF__SYSLOG__UDP_PORT=5514
      - WEF__SYSLOG__TCP_PORT=5601
      - WEF_ADMIN_USER=e2e
      - WEF_ADMIN_PASS=e2e
    volumes:
      - ./config/logthing.toml:/etc/logthing/config.toml:ro
    depends_on:
      - minio
    networks:
      - e2e

  logthing-kerberos:
    build:
      context: ../../..
      dockerfile: tests/e2e/simulation-environment/Dockerfile.kerberos
    image: logthing:e2e-kerberos
    environment:
      - RUST_LOG=info
      - WEF__TLS__ENABLED=false
      - WEF__SYSLOG__ENABLED=true
      - WEF__SYSLOG__UDP_PORT=5514
      - WEF__SYSLOG__TCP_PORT=5601
    volumes:
      - ./config/logthing-kerberos.toml:/etc/logthing/config.toml:ro
    depends_on:
      - minio
    networks:
      - e2e

  minio:
    image: minio/minio:RELEASE.2024-01-16T16-07-38Z
    environment:
      - MINIO_ROOT_USER=miniouser
      - MINIO_ROOT_PASSWORD=miniopassword
    command: server /data --console-address ':9001'
    expose:
      - "9000"
      - "9001"
    networks:
      - e2e

  minio-setup:
    image: minio/mc:latest
    environment:
      - MINIO_ROOT_USER=miniouser
      - MINIO_ROOT_PASSWORD=miniopassword
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "until mc alias set local http://minio:9000 $$MINIO_ROOT_USER $$MINIO_ROOT_PASSWORD; do sleep 2; done &&
       mc mb --ignore-existing local/wef-events"
    depends_on:
      - minio
    networks:
      - e2e

  wef-generator:
    build:
      context: .
      dockerfile: wef-generator/Dockerfile
    environment:
      - WEF_ENDPOINT=http://logthing:5985
      - WEF_STATS_ENDPOINT=http://logthing:5985/stats/throughput
      - PARSER_DIR=/app/parsers
      - EXPECTED_EVENT_IDS=4624,4625,4634,4647,4648,4649,4656,4657,4658,4660,4661,4662,4663,4670,4672,4673,4674,4688,4689,4697,4698,4699,4700,4702,4719,4720,4722,4723,4724,4725,4726,4727,4728,4729,4730,4731,4732,4733,4735,4737,4740,4741,4742,4743,4756,4757,4767,4768,4769,4770
    volumes:
      - ../../../config/event_parsers:/app/parsers:ro
    networks:
      - e2e

  syslog-generator:
    build:
      context: .
      dockerfile: syslog-generator/Dockerfile
    environment:
      - SYSLOG_HOST=logthing
      - SYSLOG_UDP_PORT=5514
      - SYSLOG_TCP_PORT=5601
      - SYSLOG_HTTP_ENDPOINT=http://logthing:5985/syslog
    depends_on:
      - logthing
    networks:
      - e2e

  s3-verifier:
    build:
      context: .
      dockerfile: s3-verifier/Dockerfile
    environment:
      - MINIO_ENDPOINT=http://minio:9000
      - MINIO_BUCKET=wef-events
      - AWS_ACCESS_KEY_ID=miniouser
      - AWS_SECRET_ACCESS_KEY=miniopassword
      - WEF_STATS_ENDPOINT=http://logthing:5985/stats/throughput
      - EXPECTED_EVENT_TOTAL=50
    networks:
      - e2e

  kerberos-test:
    build:
      context: .
      dockerfile: kerberos-test/Dockerfile
    environment:
      - WEF_ENDPOINT=http://logthing-kerberos:5985
      - WEF_TIMEOUT_SECS=60
    depends_on:
      - logthing-kerberos
    networks:
      - e2e

  parsing-validator:
    build:
      context: .
      dockerfile: parsing-validator/Dockerfile
    environment:
      - MINIO_ENDPOINT=http://minio:9000
      - MINIO_BUCKET=wef-events
      - AWS_ACCESS_KEY_ID=miniouser
      - AWS_SECRET_ACCESS_KEY=miniopassword
      - WEF_STATS_ENDPOINT=http://logthing:5985/stats/throughput
      - PARSER_DIR=/app/parsers
      - E2E_TIMEOUT_SECS=120
    volumes:
      - ../../../config/event_parsers:/app/parsers:ro
    networks:
      - e2e

  logthing-tls:
    build:
      context: ../../..
    image: logthing:e2e
    environment:
      - RUST_LOG=info
      - WEF__TLS__ENABLED=true
      - WEF__TLS__PORT=5986
      - WEF__SYSLOG__ENABLED=true
      - WEF__SYSLOG__UDP_PORT=5514
      - WEF__SYSLOG__TCP_PORT=5601
      - WEF_ADMIN_USER=e2e
      - WEF_ADMIN_PASS=e2e
    volumes:
      - ./config/logthing-tls.toml:/etc/logthing/config.toml:ro
      - ./certs/server.crt:/etc/logthing/certs/server.crt:ro
      - ./certs/server.key:/etc/logthing/certs/server.key:ro
    depends_on:
      - minio
    networks:
      - e2e

  tls-test:
    build:
      context: .
      dockerfile: tls-test/Dockerfile
    environment:
      - HTTP_ENDPOINT=http://logthing-tls:5985
      - HTTPS_ENDPOINT=https://logthing-tls:5986
      - TLS_TEST_TIMEOUT=60
    depends_on:
      - logthing-tls
    networks:
      - e2e

  performance-test:
    build:
      context: .
      dockerfile: performance-test/Dockerfile
    environment:
      - WEF_ENDPOINT=http://logthing:5985
      - WEF_STATS_ENDPOINT=http://logthing:5985/stats/throughput
      - PERF_TEST_TOTAL_EVENTS=50000
      - PERF_TEST_BATCH_SIZE=1000
      - PERF_TEST_TIMEOUT_SECS=300
      - PERF_TEST_TARGET_EPS=0
    depends_on:
      - logthing
    networks:
      - e2e

  performance-test-100k:
    build:
      context: .
      dockerfile: performance-test/Dockerfile
    environment:
      - WEF_ENDPOINT=http://logthing:5985
      - WEF_STATS_ENDPOINT=http://logthing:5985/stats/throughput
      - PERF_TEST_TOTAL_EVENTS=1000000
      - PERF_TEST_BATCH_SIZE=1000
      - PERF_TEST_TIMEOUT_SECS=300
      - PERF_TEST_TARGET_EPS=100000
    depends_on:
      - logthing
    networks:
      - e2e

  performance-test-200k:
    build:
      context: .
      dockerfile: performance-test/Dockerfile
    environment:
      - WEF_ENDPOINT=http://logthing:5985
      - WEF_STATS_ENDPOINT=http://logthing:5985/stats/throughput
      - PERF_TEST_TOTAL_EVENTS=2000000
      - PERF_TEST_BATCH_SIZE=1000
      - PERF_TEST_TIMEOUT_SECS=300
      - PERF_TEST_TARGET_EPS=200000
    depends_on:
      - logthing
    networks:
      - e2e

  performance-test-500k:
    build:
      context: .
      dockerfile: performance-test/Dockerfile
    environment:
      - WEF_ENDPOINT=http://logthing:5985
      - WEF_STATS_ENDPOINT=http://logthing:5985/stats/throughput
      - PERF_TEST_TOTAL_EVENTS=5000000
      - PERF_TEST_BATCH_SIZE=1000
      - PERF_TEST_TIMEOUT_SECS=600
      - PERF_TEST_TARGET_EPS=500000
    depends_on:
      - logthing
    networks:
      - e2e

  logthing-10k-sustained:
    build:
      context: ../../..
    image: logthing:e2e
    environment:
      - RUST_LOG=info
      - WEF__TLS__ENABLED=false
      - WEF__SYSLOG__ENABLED=true
      - WEF__SYSLOG__UDP_PORT=5514
      - WEF__SYSLOG__TCP_PORT=5601
      - WEF_ADMIN_USER=e2e
      - WEF_ADMIN_PASS=e2e
    volumes:
      - ./config/logthing-10k-sustained.toml:/etc/logthing/config.toml:ro
    depends_on:
      - minio
    networks:
      - e2e

  performance-test-10k-sustained:
    build:
      context: .
      dockerfile: performance-test/Dockerfile
    environment:
      - WEF_ENDPOINT=http://logthing-10k-sustained:5985
      - WEF_STATS_ENDPOINT=http://logthing-10k-sustained:5985/stats/throughput
      - PERF_TEST_DURATION_SECS=60
      - PERF_TEST_BATCH_SIZE=1000
      - PERF_TEST_TARGET_EPS=10000
      - PERF_TEST_EVENT_TYPE=4624
      - PERF_TEST_VERIFY_S3=true
      - S3_ENDPOINT=http://minio:9000
      - S3_BUCKET=wef-events
      - AWS_ACCESS_KEY_ID=miniouser
      - AWS_SECRET_ACCESS_KEY=miniopassword
    depends_on:
      - logthing-10k-sustained
    networks:
      - e2e

  performance-test-max-throughput:
    build:
      context: .
      dockerfile: performance-test/Dockerfile
    environment:
      - WEF_ENDPOINT=http://logthing-10k-sustained:5985
      - WEF_STATS_ENDPOINT=http://logthing-10k-sustained:5985/stats/throughput
      - PERF_TEST_DURATION_SECS=60
      - PERF_TEST_BATCH_SIZE=1000
      - PERF_TEST_TARGET_EPS=0
      - PERF_TEST_EVENT_TYPE=4624
      - PERF_TEST_VERIFY_S3=true
      - S3_ENDPOINT=http://minio:9000
      - S3_BUCKET=wef-events
      - AWS_ACCESS_KEY_ID=miniouser
      - AWS_SECRET_ACCESS_KEY=miniopassword
    depends_on:
      - logthing-10k-sustained
    networks:
      - e2e

networks:
  e2e:
    driver: bridge
