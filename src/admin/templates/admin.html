<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>WEF Admin Console</title>
    <style>
        :root {
            color-scheme: light dark;
            --bg: linear-gradient(135deg, #101726 0%, #1e1c2a 45%, #1f2f3a 100%);
            --panel-bg: rgba(17, 24, 39, 0.75);
            --accent: #64d2ff;
            --accent-strong: #14b8a6;
            --text: #f4f6fb;
            --muted: #9ba5be;
            --danger: #ff6b6b;
            font-family: "Space Grotesk", "Segoe UI", system-ui, sans-serif;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            min-height: 100vh;
            background: var(--bg);
            color: var(--text);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        .shell {
            width: min(1100px, 100%);
            background: var(--panel-bg);
            border-radius: 24px;
            padding: 2.5rem;
            box-shadow: 0 20px 50px rgba(0,0,0,0.35);
            border: 1px solid rgba(255,255,255,0.08);
            backdrop-filter: blur(12px);
        }
        h1 {
            margin: 0 0 0.5rem;
            font-size: 1.9rem;
            letter-spacing: 0.04em;
        }
        p.subtitle {
            margin: 0 0 2rem;
            color: var(--muted);
        }
        .security-notice {
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.3);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            color: var(--danger);
        }
        form {
            display: grid;
            gap: 1.5rem;
        }
        fieldset {
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 18px;
            padding: 1.5rem;
            background: rgba(255,255,255,0.01);
        }
        legend {
            font-weight: 600;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            color: var(--accent);
            padding: 0 0.5rem;
        }
        label {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
            font-size: 0.95rem;
            color: var(--muted);
        }
        input[type="text"],
        input[type="number"],
        textarea,
        select {
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 12px;
            padding: 0.65rem 0.85rem;
            font-size: 1rem;
            background: rgba(0,0,0,0.25);
            color: var(--text);
            font-family: inherit;
        }
        textarea { min-height: 5.5rem; resize: vertical; }
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
        }
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
        }
        .check-row {
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }
        .check-row label {
            flex-direction: row;
            align-items: center;
            gap: 0.4rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text);
        }
        .actions {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }
        button {
            background: linear-gradient(120deg, var(--accent), var(--accent-strong));
            border: none;
            color: #051923;
            font-weight: 600;
            font-size: 1rem;
            letter-spacing: 0.04em;
            padding: 0.85rem 1.8rem;
            border-radius: 999px;
            cursor: pointer;
            transition: transform 120ms ease;
        }
        button:hover { transform: translateY(-1px) scale(1.01); }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #status {
            font-size: 0.95rem;
            min-height: 1.2rem;
        }
        #status.ok { color: #5befc0; }
        #status.err { color: #ff6b6b; }
        .audit-section {
            margin-top: 2rem;
        }
        .audit-entry {
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        .audit-entry .timestamp {
            color: var(--muted);
            font-size: 0.8rem;
        }
        @media (max-width: 700px) {
            body { padding: 1rem; }
            .shell { padding: 1.5rem; }
        }
    </style>
</head>
<body>
    <div class="shell">
        <h1>WEF Admin Console</h1>
        <p class="subtitle">Inspect and adjust runtime configuration. Changes persist to <code>wef-server.admin.toml</code>.</p>
        
        <div class="security-notice">
            <strong>Security Notice:</strong> This interface is protected by authentication, 
            IP whitelisting, and audit logging. All changes are tracked.
        </div>
        
        <form id="config-form">
            <input type="hidden" name="csrf_token" value="{{CSRF_TOKEN}}" />
            
            <fieldset>
                <legend>Core</legend>
                <div class="grid-2">
                    <label>Bind Address
                        <input type="text" name="bind_address" required />
                    </label>
                    <label>Log Level
                        <select name="logging_level">
                            <option value="trace">trace</option>
                            <option value="debug">debug</option>
                            <option value="info">info</option>
                            <option value="warn">warn</option>
                            <option value="error">error</option>
                        </select>
                    </label>
                    <label>Log Format
                        <select name="logging_format">
                            <option value="pretty">pretty</option>
                            <option value="json">json</option>
                        </select>
                    </label>
                </div>
            </fieldset>

            <fieldset>
                <legend>TLS</legend>
                <div class="grid-3">
                    <label>Port
                        <input type="number" name="tls_port" min="1" max="65535" />
                    </label>
                    <label>Certificate File
                        <input type="text" name="tls_cert" />
                    </label>
                    <label>Key File
                        <input type="text" name="tls_key" />
                    </label>
                    <label>CA File
                        <input type="text" name="tls_ca" />
                    </label>
                </div>
                <div class="check-row">
                    <label><input type="checkbox" name="tls_enabled" /> TLS Enabled</label>
                    <label><input type="checkbox" name="tls_require_client" /> Require Client Cert</label>
                </div>
            </fieldset>

            <fieldset>
                <legend>Security</legend>
                <div class="grid-3">
                    <label>Max Connections
                        <input type="number" name="security_max_connections" min="1" />
                    </label>
                    <label>Connection Timeout (secs)
                        <input type="number" name="security_timeout" min="0" />
                    </label>
                </div>
                <label>Allowed IPs (one per line)
                    <textarea name="security_allowed_ips" placeholder="192.168.0.0/24"></textarea>
                </label>
            </fieldset>

            <fieldset>
                <legend>Forwarding</legend>
                <div class="grid-3">
                    <label>Buffer Size
                        <input type="number" name="forwarding_buffer_size" min="0" />
                    </label>
                    <label>Retry Attempts
                        <input type="number" name="forwarding_retry_attempts" min="0" />
                    </label>
                </div>
                <label>Destinations (JSON array)
                    <textarea name="forwarding_destinations" placeholder='[{"name":"siem","url":"https://..."}]'></textarea>
                </label>
            </fieldset>

            <fieldset>
                <legend>Metrics</legend>
                <div class="grid-2">
                    <label>Port
                        <input type="number" name="metrics_port" min="1" max="65535" />
                    </label>
                </div>
                <div class="check-row">
                    <label><input type="checkbox" name="metrics_enabled" /> Metrics Enabled</label>
                </div>
            </fieldset>

            <fieldset>
                <legend>Syslog</legend>
                <div class="grid-3">
                    <label>UDP Port
                        <input type="number" name="syslog_udp_port" min="1" max="65535" />
                    </label>
                    <label>TCP Port
                        <input type="number" name="syslog_tcp_port" min="1" max="65535" />
                    </label>
                </div>
                <div class="check-row">
                    <label><input type="checkbox" name="syslog_enabled" /> Syslog Enabled</label>
                    <label><input type="checkbox" name="syslog_parse_dns" /> Parse DNS Logs</label>
                </div>
            </fieldset>

            <div class="actions">
                <button type="submit">Save Configuration</button>
                <button type="button" id="validate-btn">Validate</button>
                <button type="button" id="diff-btn">Show Diff</button>
                <button type="button" id="export-btn">Export</button>
                <button type="button" id="import-btn">Import</button>
                <button type="button" id="reload-btn">Reload</button>
                <button type="button" id="audit-btn">View Audit Log</button>
                <span id="status"></span>
            </div>
        </form>
        
        <div id="validation-section" class="audit-section" style="display: none;">
            <h2>Configuration Validation</h2>
            <div id="validation-results"></div>
        </div>
        
        <div id="diff-section" class="audit-section" style="display: none;">
            <h2>Configuration Diff</h2>
            <div id="diff-results"></div>
        </div>
        
        <div id="audit-section" class="audit-section" style="display: none;">
            <h2>Recent Audit Log</h2>
            <div id="audit-entries"></div>
        </div>
        
        <input type="file" id="import-file" style="display: none;" accept=".toml,.json" />
    </div>

    <script>
        const form = document.getElementById('config-form');
        const statusEl = document.getElementById('status');
        const auditBtn = document.getElementById('audit-btn');
        const auditSection = document.getElementById('audit-section');
        const auditEntries = document.getElementById('audit-entries');
        let currentConfig = null;
        
        // Get CSRF token from the form
        const csrfToken = form.querySelector('[name="csrf_token"]').value;
        
        // Helper function to add CSRF token to headers
        const getHeaders = (contentType = null) => {
            const headers = {
                'X-CSRF-Token': csrfToken
            };
            if (contentType) {
                headers['Content-Type'] = contentType;
            }
            return headers;
        };

        const setStatus = (message, ok = false) => {
            statusEl.textContent = message;
            statusEl.className = ok ? 'ok' : 'err';
        };

        const toInt = (value, fallback) => {
            const parsed = parseInt(value, 10);
            return Number.isFinite(parsed) ? parsed : fallback;
        };

        const fillForm = (cfg) => {
            form.bind_address.value = cfg.bind_address || '';
            form.logging_level.value = cfg.logging?.level || 'info';
            form.logging_format.value = (cfg.logging?.format || 'Pretty').toString().toLowerCase();

            form.tls_enabled.checked = cfg.tls?.enabled ?? false;
            form.tls_port.value = cfg.tls?.port ?? '';
            form.tls_cert.value = cfg.tls?.cert_file || '';
            form.tls_key.value = cfg.tls?.key_file || '';
            form.tls_ca.value = cfg.tls?.ca_file || '';
            form.tls_require_client.checked = cfg.tls?.require_client_cert ?? false;

            form.security_allowed_ips.value = (cfg.security?.allowed_ips || []).join('\n');
            form.security_max_connections.value = cfg.security?.max_connections ?? '';
            form.security_timeout.value = cfg.security?.connection_timeout_secs ?? '';

            form.forwarding_buffer_size.value = cfg.forwarding?.buffer_size ?? '';
            form.forwarding_retry_attempts.value = cfg.forwarding?.retry_attempts ?? '';
            form.forwarding_destinations.value = JSON.stringify(cfg.forwarding?.destinations || [], null, 2);

            form.metrics_enabled.checked = cfg.metrics?.enabled ?? false;
            form.metrics_port.value = cfg.metrics?.port ?? '';

            form.syslog_enabled.checked = cfg.syslog?.enabled ?? false;
            form.syslog_udp_port.value = cfg.syslog?.udp_port ?? '';
            form.syslog_tcp_port.value = cfg.syslog?.tcp_port ?? '';
            form.syslog_parse_dns.checked = cfg.syslog?.parse_dns ?? false;
        };

        const textareaToList = (value) =>
            value.split('\n').map((line) => line.trim()).filter(Boolean);

        const buildPayload = () => {
            const payload = JSON.parse(JSON.stringify(currentConfig));
            payload.bind_address = form.bind_address.value.trim();
            payload.logging.level = form.logging_level.value;
            payload.logging.format = form.logging_format.value;

            payload.tls.enabled = form.tls_enabled.checked;
            payload.tls.port = toInt(form.tls_port.value, payload.tls.port);
            payload.tls.cert_file = form.tls_cert.value.trim() || null;
            payload.tls.key_file = form.tls_key.value.trim() || null;
            payload.tls.ca_file = form.tls_ca.value.trim() || null;
            payload.tls.require_client_cert = form.tls_require_client.checked;

            payload.security.allowed_ips = textareaToList(form.security_allowed_ips.value);
            payload.security.max_connections = toInt(form.security_max_connections.value, payload.security.max_connections);
            payload.security.connection_timeout_secs = toInt(form.security_timeout.value, payload.security.connection_timeout_secs);

            payload.forwarding.buffer_size = toInt(form.forwarding_buffer_size.value, payload.forwarding.buffer_size);
            payload.forwarding.retry_attempts = toInt(form.forwarding_retry_attempts.value, payload.forwarding.retry_attempts);
            const parsedDestinations = JSON.parse(form.forwarding_destinations.value || '[]');
            if (!Array.isArray(parsedDestinations)) {
                throw new Error('Destinations must be a JSON array');
            }
            payload.forwarding.destinations = parsedDestinations;

            payload.metrics.enabled = form.metrics_enabled.checked;
            payload.metrics.port = toInt(form.metrics_port.value, payload.metrics.port);

            payload.syslog.enabled = form.syslog_enabled.checked;
            payload.syslog.udp_port = toInt(form.syslog_udp_port.value, payload.syslog.udp_port);
            payload.syslog.tcp_port = toInt(form.syslog_tcp_port.value, payload.syslog.tcp_port);
            payload.syslog.parse_dns = form.syslog_parse_dns.checked;

            return payload;
        };

        const loadConfig = async () => {
            try {
                const res = await fetch('/config');
                if (!res.ok) throw new Error('Failed to load config');
                currentConfig = await res.json();
                fillForm(currentConfig);
                setStatus('Configuration loaded', true);
            } catch (err) {
                setStatus(err.message || 'Unable to fetch configuration');
            }
        };

        const validateConfig = async () => {
            if (!currentConfig) return;
            
            try {
                const payload = buildPayload();
                const res = await fetch('/config/validate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                
                const result = await res.json();
                const validationSection = document.getElementById('validation-section');
                const validationResults = document.getElementById('validation-results');
                
                let html = `<div style="padding: 1rem; border-radius: 8px; background: ${result.valid ? 'rgba(91, 239, 192, 0.1)' : 'rgba(255, 107, 107, 0.1)'}; border: 1px solid ${result.valid ? '#5befc0' : '#ff6b6b'};">`;
                html += `<strong>${result.valid ? '✓ Configuration is valid' : '✗ Configuration has errors'}</strong>`;
                
                if (result.errors.length > 0) {
                    html += '<h4>Errors:</h4><ul>';
                    result.errors.forEach(err => {
                        html += `<li style="color: #ff6b6b;">${err}</li>`;
                    });
                    html += '</ul>';
                }
                
                if (result.warnings.length > 0) {
                    html += '<h4>Warnings:</h4><ul>';
                    result.warnings.forEach(warn => {
                        html += `<li style="color: #ffc107;">${warn}</li>`;
                    });
                    html += '</ul>';
                }
                
                html += '</div>';
                validationResults.innerHTML = html;
                validationSection.style.display = 'block';
                
                setStatus(`Validation ${result.valid ? 'passed' : 'failed'}`, result.valid);
            } catch (err) {
                setStatus('Validation failed: ' + err.message);
            }
        };

        const showDiff = async () => {
            if (!currentConfig) return;
            
            try {
                const payload = buildPayload();
                const res = await fetch('/config/diff', {
                    method: 'POST',
                    headers: getHeaders('application/json'),
                    body: JSON.stringify(payload),
                });
                
                const diff = await res.json();
                const diffSection = document.getElementById('diff-section');
                const diffResults = document.getElementById('diff-results');
                
                let html = '';
                
                if (diff.changed.length === 0 && diff.added.length === 0 && diff.removed.length === 0) {
                    html = '<p style="color: #5befc0;">No changes detected - configuration is identical to current.</p>';
                } else {
                    if (diff.changed.length > 0) {
                        html += '<h4 style="color: #ffc107;">Changed:</h4><ul>';
                        diff.changed.forEach(item => {
                            html += `<li>${item}</li>`;
                        });
                        html += '</ul>';
                    }
                    
                    if (diff.added.length > 0) {
                        html += '<h4 style="color: #5befc0;">Added:</h4><ul>';
                        diff.added.forEach(item => {
                            html += `<li>${item}</li>`;
                        });
                        html += '</ul>';
                    }
                    
                    if (diff.removed.length > 0) {
                        html += '<h4 style="color: #ff6b6b;">Removed:</h4><ul>';
                        diff.removed.forEach(item => {
                            html += `<li>${item}</li>`;
                        });
                        html += '</ul>';
                    }
                }
                
                diffResults.innerHTML = html;
                diffSection.style.display = 'block';
                
                setStatus(`Diff shows ${diff.changed.length} changes`, true);
            } catch (err) {
                setStatus('Diff failed: ' + err.message);
            }
        };

        const exportConfig = async () => {
            try {
                const res = await fetch('/config/export', {
                    method: 'POST',
                    headers: getHeaders(),
                });
                
                if (!res.ok) throw new Error('Export failed');
                
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'wef-server-backup.toml';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                setStatus('Configuration exported successfully', true);
            } catch (err) {
                setStatus('Export failed: ' + err.message);
            }
        };

        const importConfig = async (file) => {
            try {
                const content = await file.text();
                const res = await fetch('/config/import', {
                    method: 'POST',
                    headers: getHeaders('application/octet-stream'),
                    body: content,
                });
                
                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(errorText);
                }
                
                const config = await res.json();
                currentConfig = config;
                fillForm(config);
                setStatus('Configuration imported successfully', true);
                
                // Hide diff and validation sections
                document.getElementById('diff-section').style.display = 'none';
                document.getElementById('validation-section').style.display = 'none';
            } catch (err) {
                setStatus('Import failed: ' + err.message);
            }
        };

        const reloadConfig = async () => {
            const confirmReload = confirm('Reload configuration from disk? This will discard any unsaved changes.');
            if (!confirmReload) return;
            
            try {
                const res = await fetch('/config/reload', {
                    method: 'POST',
                    headers: getHeaders(),
                });
                
                if (!res.ok) throw new Error('Reload failed');
                
                const config = await res.json();
                currentConfig = config;
                fillForm(config);
                setStatus('Configuration reloaded from disk', true);
                
                // Hide diff and validation sections
                document.getElementById('diff-section').style.display = 'none';
                document.getElementById('validation-section').style.display = 'none';
            } catch (err) {
                setStatus('Reload failed: ' + err.message);
            }
        };

        // Set up event listeners
        document.getElementById('validate-btn').addEventListener('click', validateConfig);
        document.getElementById('diff-btn').addEventListener('click', showDiff);
        document.getElementById('export-btn').addEventListener('click', exportConfig);
        document.getElementById('reload-btn').addEventListener('click', reloadConfig);
        
        document.getElementById('import-btn').addEventListener('click', () => {
            document.getElementById('import-file').click();
        });
        
        document.getElementById('import-file').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                importConfig(file);
            }
        });

        const loadAuditLog = async () => {
            try {
                const res = await fetch('/audit-log');
                if (!res.ok) throw new Error('Failed to load audit log');
                const entries = await res.json();
                
                auditEntries.innerHTML = entries.map(entry => `
                    <div class="audit-entry">
                        <span class="timestamp">${new Date(entry.timestamp).toLocaleString()}</span>
                        <strong>${entry.action}</strong> by ${entry.username} from ${entry.client_ip}
                        ${entry.details ? `<br/><span>${entry.details}</span>` : ''}
                    </div>
                `).join('');
                
                auditSection.style.display = 'block';
            } catch (err) {
                setStatus('Failed to load audit log: ' + err.message);
            }
        };

        auditBtn.addEventListener('click', loadAuditLog);

        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            if (!currentConfig) return;

            let payload;
            try {
                payload = buildPayload();
            } catch (err) {
                setStatus(`Invalid form data: ${err.message}`);
                return;
            }

            const confirmSave = confirm('Are you sure you want to save these configuration changes? This action will be logged.');
            if (!confirmSave) return;

            try {
                const res = await fetch('/config', {
                    method: 'PUT',
                    headers: getHeaders('application/json'),
                    body: JSON.stringify(payload),
                });
                if (!res.ok) {
                    const body = await res.text();
                    throw new Error(body || 'Save failed');
                }
                currentConfig = await res.json();
                fillForm(currentConfig);
                setStatus('Configuration saved successfully', true);
            } catch (err) {
                setStatus(err.message || 'Unable to save configuration');
            }
        });

        loadConfig();
    </script>
</body>
